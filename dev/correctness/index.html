<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Correctness checks · Pigeons.jl</title><meta name="title" content="Correctness checks · Pigeons.jl"/><meta property="og:title" content="Correctness checks · Pigeons.jl"/><meta property="twitter:title" content="Correctness checks · Pigeons.jl"/><meta name="description" content="Documentation for Pigeons.jl."/><meta property="og:description" content="Documentation for Pigeons.jl."/><meta property="twitter:description" content="Documentation for Pigeons.jl."/><meta property="og:url" content="https://Julia-Tempering.github.io/Pigeons.jl/correctness/"/><meta property="twitter:url" content="https://Julia-Tempering.github.io/Pigeons.jl/correctness/"/><link rel="canonical" href="https://Julia-Tempering.github.io/Pigeons.jl/correctness/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Pigeons.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Basic usage (local)</a></li><li><a class="tocitem" href="../unidentifiable-example/">Why parallel tempering (PT)?</a></li><li><a class="tocitem" href="../parallel/">Parallelization</a></li><li><a class="tocitem" href="../mpi/">Distributed usage (MPI)</a></li><li><a class="tocitem" href="../variational/">Variational PT</a></li><li><span class="tocitem">Supported inputs</span><ul><li><a class="tocitem" href="../input-overview/">Inputs overview</a></li><li><a class="tocitem" href="../input-turing/">Turing.jl model</a></li><li><a class="tocitem" href="../input-julia/">Black-box function</a></li><li><a class="tocitem" href="../input-stan/">Stan model</a></li><li><a class="tocitem" href="../input-nonjulian/">Non-julian MCMC</a></li><li><a class="tocitem" href="../input-explorers/">Custom MCMC</a></li></ul></li><li><span class="tocitem">Outputs</span><ul><li><a class="tocitem" href="../output-overview/">Outputs overview</a></li><li><a class="tocitem" href="../output-inferencereport/">Automated reports</a></li><li><a class="tocitem" href="../output-reports/">Standard output</a></li><li><a class="tocitem" href="../output-traces/">Traces</a></li><li><a class="tocitem" href="../output-plotting/">Plots</a></li><li><a class="tocitem" href="../output-normalization/">log(Z)</a></li><li><a class="tocitem" href="../output-numerical/">Numerical</a></li><li><a class="tocitem" href="../output-online/">Online stats</a></li><li><a class="tocitem" href="../output-off-memory/">Off-memory</a></li><li><a class="tocitem" href="../output-pt/">PT diagnostics</a></li><li><a class="tocitem" href="../output-custom-types/">Custom types</a></li><li><a class="tocitem" href="../output-extended/">Extended output</a></li><li><a class="tocitem" href="../output-mpi-postprocessing/">MPI output</a></li></ul></li><li><a class="tocitem" href="../checkpoints/">Checkpoints</a></li><li class="is-active"><a class="tocitem" href>Correctness checks</a><ul class="internal"><li><a class="tocitem" href="#Correctness-checks-for-distributed/parallel-algorithms"><span>Correctness checks for distributed/parallel algorithms</span></a></li><li><a class="tocitem" href="#Correctness-checks-of-MCMC-kernels"><span>Correctness checks of MCMC kernels</span></a></li></ul></li><li><a class="tocitem" href="../pt/">More on PT</a></li><li><a class="tocitem" href="../distributed/">More on distributed PT</a></li><li><a class="tocitem" href="../interfaces/">Interfaces</a></li><li><a class="tocitem" href="../reference/">Reference</a></li><li><a class="tocitem" href="../openings/">Openings</a></li><li><a class="tocitem" href="../about-us/">About Us</a></li><li><a class="tocitem" href="../gsoc/">Google Summer of Code</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Correctness checks</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Correctness checks</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Julia-Tempering/Pigeons.jl/blob/main/docs/src/correctness.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h2 id="Correctness-checks-for-distributed/parallel-algorithms"><a class="docs-heading-anchor" href="#Correctness-checks-for-distributed/parallel-algorithms">Correctness checks for distributed/parallel algorithms</a><a id="Correctness-checks-for-distributed/parallel-algorithms-1"></a><a class="docs-heading-anchor-permalink" href="#Correctness-checks-for-distributed/parallel-algorithms" title="Permalink"></a></h2><p>It is notoriously difficult to implement correct parallel/distributed algorithms.  One strategy we use to address this is to guarantee that the code will output  precisely the same output no matter how many threads/machines are used.  We describe how this is done under the hood in the page <a href="../distributed/#distributed">Distributed PT</a>. </p><p>In practice, how is this useful? Let us say you developed a new target and you would like to make sure that it works correctly in a multi-threaded environment. To do so, add a flag to indicate to &quot;check&quot; one of the PT rounds as follows, and  enable checkpointing</p><pre><code class="language-julia hljs">using Pigeons
pigeons(target = toy_mvn_target(100), checked_round = 3, checkpoint = true)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr36"><span class="sgr1">┌ Info: </span></span>Neither traces, disk, nor online recorders included.
<span class="sgr36"><span class="sgr1">│ </span></span>   You may not have access to your samples (unless you are using a custom recorder, or maybe you just want log(Z)).
<span class="sgr36"><span class="sgr1">└ </span></span>   To add recorders, use e.g. pigeons(target = ..., record = [traces; record_default()])
────────────────────────────────────────────────────────────────────────────
  scans        Λ        time(s)    allc(B)  log(Z₁/Z₀)   min(α)     mean(α)
────────── ────────── ────────── ────────── ────────── ────────── ──────────
        2        7.5   2.34e-05    1.1e+04       -122   2.66e-15      0.167
        4       5.56   3.35e-05   1.18e+04       -119    2.6e-07      0.382
        8       5.82   5.38e-05   1.61e+04       -114    0.00137      0.353
<span class="sgr36"><span class="sgr1">┌ Info: </span></span>Neither traces, disk, nor online recorders included.
<span class="sgr36"><span class="sgr1">│ </span></span>   You may not have access to your samples (unless you are using a custom recorder, or maybe you just want log(Z)).
<span class="sgr36"><span class="sgr1">└ </span></span>   To add recorders, use e.g. pigeons(target = ..., record = [traces; record_default()])
<span class="sgr36"><span class="sgr1">┌ Info: </span></span>Neither traces, disk, nor online recorders included.
<span class="sgr36"><span class="sgr1">│ </span></span>   You may not have access to your samples (unless you are using a custom recorder, or maybe you just want log(Z)).
<span class="sgr36"><span class="sgr1">└ </span></span>   To add recorders, use e.g. pigeons(target = ..., record = [traces; record_default()])
────────────────────────────────────────────────────────────────────────────
  scans        Λ        time(s)    allc(B)  log(Z₁/Z₀)   min(α)     mean(α)
────────── ────────── ────────── ────────── ────────── ────────── ──────────
        2        7.5   7.06e-05    1.1e+04       -122   2.66e-15      0.167
        4       5.56   5.15e-05   1.18e+04       -119    2.6e-07      0.382
        8       5.82   6.13e-05   1.61e+04       -114    0.00137      0.353
────────────────────────────────────────────────────────────────────────────
       16       7.02   0.000121   2.15e+04       -116   0.000205      0.219
       32       7.14   0.000181   2.76e+04       -112     0.0379      0.206
       64       7.18   0.000344   3.96e+04       -116     0.0442      0.202
      128        7.2   0.000673   5.86e+04       -114      0.142        0.2
      256       7.21    0.00133   5.66e+04       -115      0.151      0.199
      512       7.14    0.00259   7.45e+04       -115       0.19      0.207
 1.02e+03       7.12    0.00509   7.02e+04       -115      0.173      0.209
────────────────────────────────────────────────────────────────────────────</code></pre><p>The above line does the following: the PT algorithm will pause at the end of round 3, spawn  a separate process with only one thread in it, run 3 rounds of PT with the same  <a href="../reference/#Pigeons.Inputs"><code>Inputs</code></a> object in it, and verify that the checkpoints of the single-threaded run  is identical to   the one that ran in the main process. If not, an error will be raised with some  information on where the discrepancy comes from.  Try to pick the checked round to be small enough that it does not dominate the running time  (since it runs in single-threaded, single-process mode), but big enough to achieve  the same code coverage as the full algorithm. Setting it to zero (or omitting the argument),  disables this functionality.</p><p>Did the code above actually use many threads? This depends on the value of <code>Threads.nthreads()</code>. Julia currently does not allow you to change this value at  runtime, so for convenience we provide the following way to run the job in a  child process with a set number of Julia threads:</p><pre><code class="language-julia hljs">pt_result = pigeons(target = toy_mvn_target(100), multithreaded = true, checked_round = 3, checkpoint = true, on = ChildProcess(n_threads = 4))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Result{PT}(&quot;/home/runner/work/Pigeons.jl/Pigeons.jl/docs/build/results/all/2025-03-05-03-39-53-7T38NTEq&quot;)</code></pre><p>Notice that we also add the flag <code>multithreaded = true</code>, to instruct Pigeons to use  the multiple threads available to parallelize exploration across chains (in other use cases,  parallelization might get used internally e.g. to parallelize likelihood evaluation).</p><p>Here the check passed successfully as expected. But what  if you had a third-party target distribution that is not multi-threaded friendly?  For example some code sometimes write in global variables or  other non-thread safe constructs. In such situation, you can still use your thread-naive  target over MPI <em>processes</em>.  For example, if the thread-unsafety comes from the use of global variables, then each  process will have its own copy of the global variables. </p><div class="admonition is-info"><header class="admonition-header">Failed equality check</header><div class="admonition-body"><p>If you are using a custom struct that is either mutable or containing  mutables, it is possible that the check will fail even if your implementation is sound. This is caused by <code>==</code> dispatching <code>===</code> on your type, which is too strict for the purpose of comparing two deserialized checkpoints. See <a href="../reference/#Pigeons.recursive_equal-Tuple{Any, Any}"><code>recursive_equal</code></a> for instructions on how to prevent this behavior.</p></div></div><h2 id="Correctness-checks-of-MCMC-kernels"><a class="docs-heading-anchor" href="#Correctness-checks-of-MCMC-kernels">Correctness checks of MCMC kernels</a><a id="Correctness-checks-of-MCMC-kernels-1"></a><a class="docs-heading-anchor-permalink" href="#Correctness-checks-of-MCMC-kernels" title="Permalink"></a></h2><p>Pigeons offers a tool, the Exact Invariance Test (EIT), to help validating  correctness of MCMC kernels. It formulates an hypothesis test where the  null hypothesis is that the provided <a href="../interfaces/#explorer"><code>explorer</code></a> kernel is  invariant with respect to the target distribution. For details, see  <a href="https://www.jstatsoft.org/article/view/v103i11">Bouchard-Côté, 2022, Section 10.5</a> or <a href="https://ubc-stat-ml.github.io/web447/w12_mcmc2/topic08_debug.html">this tutorial</a>. </p><p>Using EIT is as simple as defining a Bayesian model with a proper prior  using the Turing syntax, and then calling <a href="../reference/#Pigeons.invariance_test"><code>invariance_test()</code></a>: </p><pre><code class="language-julia hljs">using Pigeons
using Distributions
using DynamicPPL
using HypothesisTests

# note: observation should not be an argument of the Turing model
DynamicPPL.@model function some_generative_model(n_trials)
    p1 ~ Uniform()
    p2 ~ Uniform()
    n_successes ~ Binomial(n_trials, p1*p2)
    return n_successes
end

model = some_generative_model(100)
target = TuringLogPotential(model)
explorer = SliceSampler()
test_result = Pigeons.invariance_test(
                target,
                explorer;
                condition_on=(:n_successes,))

@assert test_result.passed</code></pre><p>EIT checks for invariance but not irreducibility.  Being able to check invariance irrespective of irreducibility is beneficial: for example if a Gibbs sampler has two moves, one can then test each in isolation  each of the two moves. Moreover,   in case of failure, we can determine which of the two moves would be problematic. </p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../checkpoints/">« Checkpoints</a><a class="docs-footer-nextpage" href="../pt/">More on PT »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Wednesday 5 March 2025 03:50">Wednesday 5 March 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
