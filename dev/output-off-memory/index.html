<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Off-memory · Pigeons.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://Julia-Tempering.github.io/Pigeons.jl/output-off-memory/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Pigeons.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Basic usage (local)</a></li><li><a class="tocitem" href="../unidentifiable-example/">Why PT?</a></li><li><a class="tocitem" href="../parallel/">Parallelization</a></li><li><a class="tocitem" href="../mpi/">Distributed usage (MPI)</a></li><li><a class="tocitem" href="../variational/">Variational PT</a></li><li><span class="tocitem">Supported inputs</span><ul><li><a class="tocitem" href="../input-overview/">Inputs overview</a></li><li><a class="tocitem" href="../input-turing/">Turing.jl model</a></li><li><a class="tocitem" href="../input-julia/">Black-box function</a></li><li><a class="tocitem" href="../input-stan/">Stan model</a></li><li><a class="tocitem" href="../input-nonjulian/">Non-julian MCMC</a></li><li><a class="tocitem" href="../input-explorers/">Custom MCMC</a></li></ul></li><li><span class="tocitem">Outputs</span><ul><li><a class="tocitem" href="../output-overview/">Outputs overview</a></li><li><a class="tocitem" href="../output-reports/">Quick reports</a></li><li><a class="tocitem" href="../output-plotting/">Plots</a></li><li><a class="tocitem" href="../output-normalization/">log(Z)</a></li><li><a class="tocitem" href="../output-numerical/">Numerical</a></li><li><a class="tocitem" href="../output-online/">Online stats</a></li><li class="is-active"><a class="tocitem" href>Off-memory</a><ul class="internal"><li><a class="tocitem" href="#Prepare-the-PT-run-with-the-disk-recorder"><span>Prepare the PT run with the disk recorder</span></a></li><li><a class="tocitem" href="#Accessing-the-disk-samples"><span>Accessing the disk samples</span></a></li><li><a class="tocitem" href="#Internal-organization-of-the-samples"><span>Internal organization of the samples</span></a></li></ul></li><li><a class="tocitem" href="../output-pt/">PT diagnostics</a></li><li><a class="tocitem" href="../output-custom-types/">Custom types</a></li><li><a class="tocitem" href="../output-extended/">Extended output</a></li><li><a class="tocitem" href="../output-mpi-postprocessing/">MPI output</a></li></ul></li><li><a class="tocitem" href="../checkpoints/">Checkpoints</a></li><li><a class="tocitem" href="../correctness/">Correctness checks</a></li><li><a class="tocitem" href="../pt/">More on PT</a></li><li><a class="tocitem" href="../distributed/">More on distributed PT</a></li><li><a class="tocitem" href="../interfaces/">Interfaces</a></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Outputs</a></li><li class="is-active"><a href>Off-memory</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Off-memory</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Julia-Tempering/Pigeons.jl/blob/main/docs/src/output-off-memory.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="output-off-memory"><a class="docs-heading-anchor" href="#output-off-memory">Off-memory processing</a><a id="output-off-memory-1"></a><a class="docs-heading-anchor-permalink" href="#output-off-memory" title="Permalink"></a></h1><p>When the dimensionality of a model is large and/or the  number of MCMC samples is large, the samples may not  fit in memory.  In some situations, it may be possible to compute the  output in finite memory, as described in  <a href="../output-online/#output-online">the online statistics documentation page</a>.  However not all situations admit sufficient statistics and  in this case it is necessary to store samples to disk.  We show here how to do so when pigeons is run on a single  machine, but the interface is similar over MPI and  described in the  <a href="../output-mpi-postprocessing/#output-mpi-postprocessing">MPI sample processing documentation page</a>. </p><h2 id="Prepare-the-PT-run-with-the-disk-recorder"><a class="docs-heading-anchor" href="#Prepare-the-PT-run-with-the-disk-recorder">Prepare the PT run with the disk recorder</a><a id="Prepare-the-PT-run-with-the-disk-recorder-1"></a><a class="docs-heading-anchor-permalink" href="#Prepare-the-PT-run-with-the-disk-recorder" title="Permalink"></a></h2><p>Two options need to be enabled.  First, <code>checkpoint = true</code>,  which saves a snapshot at the end of each round in  the directory <code>results/all/[unique directory]</code> and  symlinked to <code>results/latest</code>.  Second, the <code>disk</code> recorder:</p><pre><code class="language-julia hljs">using Pigeons

# example target: a 1000 dimensional target
high_d_target = Pigeons.toy_mvn_target(1000)

pt = pigeons(target = high_d_target,
                checkpoint = true,
                record = [disk])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">PT(&quot;/home/runner/work/Pigeons.jl/Pigeons.jl/docs/build/results/all/2023-10-04-15-52-29-tigtOe0Z&quot;)</code></pre><h2 id="Accessing-the-disk-samples"><a class="docs-heading-anchor" href="#Accessing-the-disk-samples">Accessing the disk samples</a><a id="Accessing-the-disk-samples-1"></a><a class="docs-heading-anchor-permalink" href="#Accessing-the-disk-samples" title="Permalink"></a></h2><p>Use the function <a href="../reference/#Pigeons.process_sample"><code>process_sample()</code></a> which  processes the samples one by one and passes it to  a user-provided function.  Here we will extract the first dimension of  each 1000-dimensional vector:</p><pre><code class="language-julia hljs"># load the samples from disk one by one, keeping only the first dimension
first_dim_of_each = Vector{Float64}()
process_sample(pt) do chain, scan, sample # ordered as if we had an inner loop over scans
    # each sample here is a Vector{Float64} of length 1000
    # in general, it will is produced by extract_sample()
    push!(first_dim_of_each, sample[1])
end

using Plots
plotlyjs()
myplot = Plots.plot(first_dim_of_each)
Plots.savefig(myplot, &quot;first_dim_of_each.html&quot;);</code></pre><iframe src="../first_dim_of_each.html" style="height:500px;width:100%;"></iframe><h2 id="Internal-organization-of-the-samples"><a class="docs-heading-anchor" href="#Internal-organization-of-the-samples">Internal organization of the samples</a><a id="Internal-organization-of-the-samples-1"></a><a class="docs-heading-anchor-permalink" href="#Internal-organization-of-the-samples" title="Permalink"></a></h2><p>This section can be skipped. </p><p>The samples are produced in compressed zip  folders, one for each replica having visited  the target:</p><pre><code class="language-julia hljs">readdir(&quot;$(pt.exec_folder)/round=10/samples&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{String}:
 &quot;replica=6.jls.zip&quot;
 &quot;replica=7.jls.zip&quot;</code></pre><p>In the above example we see that only replicas  6 and 7 visited the target. Each zip file  contains serialized .jl files.  This output organization is used to support  concurrent and distributed processing. </p><p>Internally, two passes are made, a first one to  index the samples which are shuffled across many files. Then they are visited in the correct  order and passed to the processing function.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../output-online/">« Online stats</a><a class="docs-footer-nextpage" href="../output-pt/">PT diagnostics »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Wednesday 4 October 2023 15:54">Wednesday 4 October 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
