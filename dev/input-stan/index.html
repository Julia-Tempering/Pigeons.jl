<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Stan model · Pigeons.jl</title><meta name="title" content="Stan model · Pigeons.jl"/><meta property="og:title" content="Stan model · Pigeons.jl"/><meta property="twitter:title" content="Stan model · Pigeons.jl"/><meta name="description" content="Documentation for Pigeons.jl."/><meta property="og:description" content="Documentation for Pigeons.jl."/><meta property="twitter:description" content="Documentation for Pigeons.jl."/><meta property="og:url" content="https://Julia-Tempering.github.io/Pigeons.jl/input-stan/"/><meta property="twitter:url" content="https://Julia-Tempering.github.io/Pigeons.jl/input-stan/"/><link rel="canonical" href="https://Julia-Tempering.github.io/Pigeons.jl/input-stan/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Pigeons.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Basic usage (local)</a></li><li><a class="tocitem" href="../unidentifiable-example/">Why parallel tempering (PT)?</a></li><li><a class="tocitem" href="../parallel/">Parallelization</a></li><li><a class="tocitem" href="../mpi/">Distributed usage (MPI)</a></li><li><a class="tocitem" href="../variational/">Variational PT</a></li><li><span class="tocitem">Supported inputs</span><ul><li><a class="tocitem" href="../input-overview/">Inputs overview</a></li><li><a class="tocitem" href="../input-turing/">Turing.jl model</a></li><li><a class="tocitem" href="../input-julia/">Black-box function</a></li><li class="is-active"><a class="tocitem" href>Stan model</a><ul class="internal"><li><a class="tocitem" href="#Sampling-from-the-reference-distribution"><span>Sampling from the reference distribution</span></a></li><li><a class="tocitem" href="#Manipulating-the-output"><span>Manipulating the output</span></a></li></ul></li><li><a class="tocitem" href="../input-nonjulian/">Non-julian MCMC</a></li><li><a class="tocitem" href="../input-explorers/">Custom MCMC</a></li></ul></li><li><span class="tocitem">Outputs</span><ul><li><a class="tocitem" href="../output-overview/">Outputs overview</a></li><li><a class="tocitem" href="../output-inferencereport/">Automated reports</a></li><li><a class="tocitem" href="../output-reports/">Standard output</a></li><li><a class="tocitem" href="../output-traces/">Traces</a></li><li><a class="tocitem" href="../output-plotting/">Plots</a></li><li><a class="tocitem" href="../output-normalization/">log(Z)</a></li><li><a class="tocitem" href="../output-numerical/">Numerical</a></li><li><a class="tocitem" href="../output-online/">Online stats</a></li><li><a class="tocitem" href="../output-off-memory/">Off-memory</a></li><li><a class="tocitem" href="../output-pt/">PT diagnostics</a></li><li><a class="tocitem" href="../output-custom-types/">Custom types</a></li><li><a class="tocitem" href="../output-extended/">Extended output</a></li><li><a class="tocitem" href="../output-mpi-postprocessing/">MPI output</a></li></ul></li><li><a class="tocitem" href="../checkpoints/">Checkpoints</a></li><li><a class="tocitem" href="../correctness/">Correctness checks</a></li><li><a class="tocitem" href="../pt/">More on PT</a></li><li><a class="tocitem" href="../distributed/">More on distributed PT</a></li><li><a class="tocitem" href="../interfaces/">Interfaces</a></li><li><a class="tocitem" href="../reference/">Reference</a></li><li><a class="tocitem" href="../openings/">Openings</a></li><li><a class="tocitem" href="../about-us/">About Us</a></li><li><a class="tocitem" href="../gsoc/">Google Summer of Code</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Supported inputs</a></li><li class="is-active"><a href>Stan model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Stan model</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Julia-Tempering/Pigeons.jl/blob/main/docs/src/input-stan.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="input-stan"><a class="docs-heading-anchor" href="#input-stan">Stan model as input to pigeons</a><a id="input-stan-1"></a><a class="docs-heading-anchor-permalink" href="#input-stan" title="Permalink"></a></h1><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>We use the package <code>BridgeStan.jl</code> as a package extension which will attempt  to automatically install Stan.  For <code>BridgeStan.jl</code> to work, a C++ compiler and  <code>make</code> are needed, see  <a href="https://roualdes.github.io/bridgestan/latest/getting-started.html#requirement-c-toolchain">the BridgeStan requirements</a>.</p></div></div><p>To target the posterior distribution specified by  a <a href="https://mc-stan.org/">Stan</a> model, use  a <a href="../reference/#Pigeons.StanLogPotential"><code>StanLogPotential</code></a>. </p><p>Here we show how this is done using our familiar <a href="../unidentifiable-example/#unidentifiable-example">unidentifiable toy example</a> <a href="https://github.com/Julia-Tempering/Pigeons.jl/blob/main/examples/stan/unid.stan">ported to the Stan language</a>.</p><pre><code class="language-julia hljs">using BridgeStan
using Pigeons
using Random

# We will use this type to make sure our iid sampler (next section) will
# be used only for this model
struct StanUnidentifiableExample end

function stan_unid(n_trials, n_successes)
    # path to a .stan file (compiled files will be cached in the same directory)
    stan_file = dirname(dirname(pathof(Pigeons))) * &quot;/examples/stan/unid.stan&quot;

    # data can be specified either using...
    #   - a path to a json file with suffix .json containing the data to condition on
    #   - the JSON string itself (here via the utility Pigeons.json())
    stan_data = Pigeons.json(; n_trials, n_successes)

    return StanLogPotential(stan_file, stan_data, StanUnidentifiableExample())
end

pt = pigeons(target = stan_unid(100, 50), reference = stan_unid(0, 0))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">BridgeStan not found at location specified by $BRIDGESTAN environment variable, downloading version 2.5.0 to /home/runner/.bridgestan/bridgestan-2.5.0
Done!
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>Loading a shared object &#39;/home/runner/work/Pigeons.jl/Pigeons.jl/examples/stan/unid_model.so&#39; which is already loaded.
<span class="sgr33"><span class="sgr1">│ </span></span>If the file has changed since the last time it was loaded, this load may not update the library!
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ BridgeStan ~/.julia/packages/BridgeStan/ccAxe/src/model.jl:59</span>
<span class="sgr36"><span class="sgr1">┌ Info: </span></span>Neither traces, disk, nor online recorders included.
<span class="sgr36"><span class="sgr1">│ </span></span>   You may not have access to your samples (unless you are using a custom recorder, or maybe you just want log(Z)).
<span class="sgr36"><span class="sgr1">└ </span></span>   To add recorders, use e.g. pigeons(target = ..., record = [traces; record_default()])
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>It looks like sample_iid!() is not implemented for a
<span class="sgr33"><span class="sgr1">│ </span></span>reference_log_potential of type StanLogPotential{...}.
<span class="sgr33"><span class="sgr1">│ </span></span>Instead, using step!().
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ Pigeons ~/work/Pigeons.jl/Pigeons.jl/src/targets/target.jl:51</span>
──────────────────────────────────────────────────────────────────────────────────────────────────
  scans        Λ        time(s)    allc(B)  log(Z₁/Z₀)   min(α)     mean(α)    min(αₑ)   mean(αₑ)
────────── ────────── ────────── ────────── ────────── ────────── ────────── ────────── ──────────
        2        1.3      0.689   1.21e+07      -5.89     0.0027      0.856      0.351      0.569
        4       1.85      0.118   4.16e+06      -4.38      0.592      0.794      0.369      0.585
        8       1.36    0.00798   1.19e+05      -4.83      0.282      0.849      0.519      0.618
       16       1.56     0.0163    2.2e+05      -4.88      0.595      0.827      0.503      0.586
       32       1.49      0.029   3.76e+05      -4.55       0.67      0.835      0.568      0.654
       64        1.4     0.0582   5.98e+05      -4.84      0.695      0.844       0.57      0.628
      128       1.53      0.118   1.05e+06      -4.95      0.754       0.83      0.552      0.618
      256       1.56      0.234   1.95e+06      -5.04      0.737      0.827      0.556      0.632
      512       1.54      0.486   3.76e+06      -5.01      0.798      0.829      0.523      0.619
 1.02e+03        1.5      0.943   7.38e+06      -4.94      0.788      0.833      0.544      0.622
──────────────────────────────────────────────────────────────────────────────────────────────────</code></pre><p>Notice that we have specified a reference distribution, in this case the same model but with  no observations (hence the prior). This needs to be done with Stan targets because it is  not possible to automatically extract a prior from a .stan file. </p><p>For a <a href="../reference/#Pigeons.StanLogPotential"><code>StanLogPotential</code></a>, the <a href="../reference/#Pigeons.default_explorer-Tuple{Any}"><code>default_explorer()</code></a> is <a href="../reference/#Pigeons.AutoMALA"><code>AutoMALA</code></a><sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup>. </p><h2 id="Sampling-from-the-reference-distribution"><a class="docs-heading-anchor" href="#Sampling-from-the-reference-distribution">Sampling from the reference distribution</a><a id="Sampling-from-the-reference-distribution-1"></a><a class="docs-heading-anchor-permalink" href="#Sampling-from-the-reference-distribution" title="Permalink"></a></h2><p>Ability to sample from the reference distribution can be beneficial, e.g. to jump modes  in multi-modal distribution.  For stan targets, this is done as follows:</p><pre><code class="language-julia hljs">using BridgeStan

function Pigeons.sample_iid!(
        log_potential::StanLogPotential{M, S, D, StanUnidentifiableExample}, replica, shared) where {M, S, D}
    # sample in constrained space
    constrained = rand(replica.rng, 2)
    # transform to unconstrained space
    replica.state.unconstrained_parameters .= BridgeStan.param_unconstrain(log_potential.model, constrained)
end

pt = pigeons(target = stan_unid(100, 50), reference = stan_unid(0, 0))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr33"><span class="sgr1">┌ Warning: </span></span>Loading a shared object &#39;/home/runner/work/Pigeons.jl/Pigeons.jl/examples/stan/unid_model.so&#39; which is already loaded.
<span class="sgr33"><span class="sgr1">│ </span></span>If the file has changed since the last time it was loaded, this load may not update the library!
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ BridgeStan ~/.julia/packages/BridgeStan/ccAxe/src/model.jl:59</span>
<span class="sgr33"><span class="sgr1">┌ Warning: </span></span>Loading a shared object &#39;/home/runner/work/Pigeons.jl/Pigeons.jl/examples/stan/unid_model.so&#39; which is already loaded.
<span class="sgr33"><span class="sgr1">│ </span></span>If the file has changed since the last time it was loaded, this load may not update the library!
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ BridgeStan ~/.julia/packages/BridgeStan/ccAxe/src/model.jl:59</span>
<span class="sgr36"><span class="sgr1">┌ Info: </span></span>Neither traces, disk, nor online recorders included.
<span class="sgr36"><span class="sgr1">│ </span></span>   You may not have access to your samples (unless you are using a custom recorder, or maybe you just want log(Z)).
<span class="sgr36"><span class="sgr1">└ </span></span>   To add recorders, use e.g. pigeons(target = ..., record = [traces; record_default()])
──────────────────────────────────────────────────────────────────────────────────────────────────
  scans        Λ        time(s)    allc(B)  log(Z₁/Z₀)   min(α)     mean(α)    min(αₑ)   mean(αₑ)
────────── ────────── ────────── ────────── ────────── ────────── ────────── ────────── ──────────
        2       1.24    0.00144   4.74e+04      -4.29     0.0658      0.863      0.383      0.593
        4       1.73    0.00391   6.67e+04       -4.2      0.429      0.808      0.476      0.607
        8        1.2    0.00655   1.22e+05      -4.52      0.706      0.867      0.481       0.59
       16       1.12     0.0132   2.07e+05      -4.64      0.702      0.875      0.598       0.65
       32       1.77      0.026   3.34e+05         -5      0.593      0.803      0.506      0.622
       64       1.45     0.0521   5.76e+05      -4.84      0.735      0.839      0.534       0.63
      128        1.5      0.105   9.92e+05      -4.81      0.733      0.834      0.555       0.63
      256       1.39      0.209   1.84e+06      -5.03      0.787      0.846      0.603      0.635
      512       1.51      0.419   3.55e+06      -4.87      0.802      0.832       0.57      0.633
 1.02e+03       1.51      0.862   6.95e+06      -4.96      0.799      0.832      0.536      0.623
──────────────────────────────────────────────────────────────────────────────────────────────────</code></pre><h2 id="Manipulating-the-output"><a class="docs-heading-anchor" href="#Manipulating-the-output">Manipulating the output</a><a id="Manipulating-the-output-1"></a><a class="docs-heading-anchor-permalink" href="#Manipulating-the-output" title="Permalink"></a></h2><p>Internally, Stan target&#39;s states are stored in an unconstrained  parameterization provided by Stan  (for example, bounded support variables are mapped to the full real line).  However, sample post-processing functions such as <a href="../reference/#Pigeons.sample_array-Tuple{PT}"><code>sample_array()</code></a> and <a href="../reference/#Pigeons.process_sample"><code>process_sample()</code></a>  convert back to the original (&quot;constrained&quot;) parameterization via <a href="../reference/#Pigeons.extract_sample-Tuple{Any, Any, Nothing}"><code>extract_sample()</code></a>. </p><p>As a result parameterization issues can be essentially ignored when post-processing, for example some  common post-processing are shown below, see <a href="../output-overview/#output-overview">the section on output processing for more information</a>. </p><pre><code class="language-julia hljs">using MCMCChains
using StatsPlots
plotlyjs()

pt = pigeons(
        target = stan_unid(100, 50),
        reference = stan_unid(0, 0),
        record = [traces])
samples = Chains(pt)
my_plot = StatsPlots.plot(samples)
StatsPlots.savefig(my_plot, &quot;stan_posterior_densities_and_traces.html&quot;);

samples</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Chains MCMC chain (1024×3×1 Array{Float64, 3}):

Iterations        = 1:1:1024
Number of chains  = 1
Samples per chain = 1024
parameters        = p1, p2
internals         = log_density

Summary Statistics
 <span class="sgr1"> parameters </span> <span class="sgr1">    mean </span> <span class="sgr1">     std </span> <span class="sgr1">    mcse </span> <span class="sgr1"> ess_bulk </span> <span class="sgr1"> ess_tail </span> <span class="sgr1">    rhat </span> <span class="sgr1"> e</span> ⋯
 <span class="sgr90">     Symbol </span> <span class="sgr90"> Float64 </span> <span class="sgr90"> Float64 </span> <span class="sgr90"> Float64 </span> <span class="sgr90">  Float64 </span> <span class="sgr90">  Float64 </span> <span class="sgr90"> Float64 </span> <span class="sgr90">  </span> ⋯

          p1    0.7039    0.1417    0.0063   491.0540   494.2846    1.0008     ⋯
          p2    0.7241    0.1416    0.0065   461.4249   519.3181    1.0024     ⋯
<span class="sgr36">                                                                1 column omitted</span>

Quantiles
 <span class="sgr1"> parameters </span> <span class="sgr1">    2.5% </span> <span class="sgr1">   25.0% </span> <span class="sgr1">   50.0% </span> <span class="sgr1">   75.0% </span> <span class="sgr1">   97.5% </span>
 <span class="sgr90">     Symbol </span> <span class="sgr90"> Float64 </span> <span class="sgr90"> Float64 </span> <span class="sgr90"> Float64 </span> <span class="sgr90"> Float64 </span> <span class="sgr90"> Float64 </span>

          p1    0.4667    0.5914    0.6945    0.8046    0.9719
          p2    0.4853    0.6109    0.7140    0.8322    0.9795
</code></pre><iframe src="../stan_posterior_densities_and_traces.html" style="height:500px;width:100%;"></iframe><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a>Biron-Lattes, M., Surjanovic, N., Syed, S., Campbell, T., &amp; Bouchard-Côté, A.. (2024). <a href="https://proceedings.mlr.press/v238/biron-lattes24a.html">autoMALA: Locally adaptive Metropolis-adjusted Langevin algorithm</a>. <em>Proceedings of The 27th International Conference on Artificial Intelligence and Statistics</em>, in <em>Proceedings of Machine Learning Research</em> 238:4600-4608.</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../input-julia/">« Black-box function</a><a class="docs-footer-nextpage" href="../input-nonjulian/">Non-julian MCMC »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Thursday 21 November 2024 17:23">Thursday 21 November 2024</span>. Using Julia version 1.10.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
