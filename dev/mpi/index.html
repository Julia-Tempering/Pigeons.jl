<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Distributed usage (MPI) · Pigeons.jl</title><meta name="title" content="Distributed usage (MPI) · Pigeons.jl"/><meta property="og:title" content="Distributed usage (MPI) · Pigeons.jl"/><meta property="twitter:title" content="Distributed usage (MPI) · Pigeons.jl"/><meta name="description" content="Documentation for Pigeons.jl."/><meta property="og:description" content="Documentation for Pigeons.jl."/><meta property="twitter:description" content="Documentation for Pigeons.jl."/><meta property="og:url" content="https://Julia-Tempering.github.io/Pigeons.jl/mpi/"/><meta property="twitter:url" content="https://Julia-Tempering.github.io/Pigeons.jl/mpi/"/><link rel="canonical" href="https://Julia-Tempering.github.io/Pigeons.jl/mpi/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Pigeons.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Basic usage (local)</a></li><li><a class="tocitem" href="../unidentifiable-example/">Why parallel tempering (PT)?</a></li><li><a class="tocitem" href="../parallel/">Parallelization</a></li><li class="is-active"><a class="tocitem" href>Distributed usage (MPI)</a><ul class="internal"><li><a class="tocitem" href="#mpi-local"><span>Running MPI locally</span></a></li><li><a class="tocitem" href="#Running-MPI-on-a-cluster"><span>Running MPI on a cluster</span></a></li><li><a class="tocitem" href="#Code-dependencies"><span>Code dependencies</span></a></li></ul></li><li><a class="tocitem" href="../variational/">Variational PT</a></li><li><span class="tocitem">Supported inputs</span><ul><li><a class="tocitem" href="../input-overview/">Inputs overview</a></li><li><a class="tocitem" href="../input-turing/">Turing.jl model</a></li><li><a class="tocitem" href="../input-julia/">Black-box function</a></li><li><a class="tocitem" href="../input-stan/">Stan model</a></li><li><a class="tocitem" href="../input-nonjulian/">Non-julian MCMC</a></li><li><a class="tocitem" href="../input-explorers/">Custom MCMC</a></li></ul></li><li><span class="tocitem">Outputs</span><ul><li><a class="tocitem" href="../output-overview/">Outputs overview</a></li><li><a class="tocitem" href="../output-reports/">Quick reports</a></li><li><a class="tocitem" href="../output-traces/">Traces</a></li><li><a class="tocitem" href="../output-plotting/">Plots</a></li><li><a class="tocitem" href="../output-normalization/">log(Z)</a></li><li><a class="tocitem" href="../output-numerical/">Numerical</a></li><li><a class="tocitem" href="../output-online/">Online stats</a></li><li><a class="tocitem" href="../output-off-memory/">Off-memory</a></li><li><a class="tocitem" href="../output-pt/">PT diagnostics</a></li><li><a class="tocitem" href="../output-custom-types/">Custom types</a></li><li><a class="tocitem" href="../output-extended/">Extended output</a></li><li><a class="tocitem" href="../output-mpi-postprocessing/">MPI output</a></li></ul></li><li><a class="tocitem" href="../checkpoints/">Checkpoints</a></li><li><a class="tocitem" href="../correctness/">Correctness checks</a></li><li><a class="tocitem" href="../pt/">More on PT</a></li><li><a class="tocitem" href="../distributed/">More on distributed PT</a></li><li><a class="tocitem" href="../interfaces/">Interfaces</a></li><li><a class="tocitem" href="../reference/">Reference</a></li><li><a class="tocitem" href="../gsoc/">Google Summer of Code</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Distributed usage (MPI)</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Distributed usage (MPI)</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Julia-Tempering/Pigeons.jl/blob/main/docs/src/mpi.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Distributed-sampling-over-MPI-using-Pigeons"><a class="docs-heading-anchor" href="#Distributed-sampling-over-MPI-using-Pigeons">Distributed sampling over MPI using Pigeons</a><a id="Distributed-sampling-over-MPI-using-Pigeons-1"></a><a class="docs-heading-anchor-permalink" href="#Distributed-sampling-over-MPI-using-Pigeons" title="Permalink"></a></h1><h2 id="mpi-local"><a class="docs-heading-anchor" href="#mpi-local">Running MPI locally</a><a id="mpi-local-1"></a><a class="docs-heading-anchor-permalink" href="#mpi-local" title="Permalink"></a></h2><p>To run MPI locally on one machine, using 4 MPI processes, use:</p><pre><code class="language-julia hljs">using Pigeons
result = pigeons(
    target = toy_mvn_target(100),
    checkpoint = true,
    on = ChildProcess(
            n_local_mpi_processes = 4))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Result{PT}(&quot;/home/runner/work/Pigeons.jl/Pigeons.jl/docs/build/results/all/2024-06-28-16-20-33-Mogn1H1k&quot;)</code></pre><p>Note that if <code>n_local_mpi_processes</code> exceeds the number of cores, performance  will steeply degrade (in contrast to threads, for which performance degrades  much more gracefully when the number of threads exceeds the number of cores). </p><p>Using <code>on = ChildProcess(...)</code> is also useful to change the  number of threads without having to restart the Julia session.  For example, to start 4 child processes, each with two threads concurrently sharing work  across the chains, use:</p><pre><code class="language-julia hljs">result = pigeons(
    target = toy_mvn_target(100),
    multithreaded = true,
    checkpoint = true,
    on = ChildProcess(
            n_local_mpi_processes = 4,
            n_threads = 2))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Result{PT}(&quot;/home/runner/work/Pigeons.jl/Pigeons.jl/docs/build/results/all/2024-06-28-16-20-56-or2Fs04L&quot;)</code></pre><p>Alternatively, if instead of using the 2 threads to parallelize across chain, we want to use them to parallelize e.g. a custom likelihood evalutation over datapoints, set <code>multithreaded = false</code> to  indicate to pigeons it is not responsible for the multithreading (<code>multithreaded = false</code> is the default behaviour):</p><pre><code class="language-julia hljs">result = pigeons(
    target = toy_mvn_target(100),
    multithreaded = false, # can be skipped, the default
    checkpoint = true,
    on = ChildProcess(
            n_local_mpi_processes = 4,
            n_threads = 2))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Result{PT}(&quot;/home/runner/work/Pigeons.jl/Pigeons.jl/docs/build/results/all/2024-06-28-16-21-47-frFMMXdE&quot;)</code></pre><p>To analyze the output, see the documentation page on <a href="../output-mpi-postprocessing/#output-mpi-postprocessing">post-processing for MPI runs</a>. Briefly, one option is to load the state of the sampler  back to your interactive chain via: </p><pre><code class="language-julia hljs">pt = Pigeons.load(result) # possible thanks to &#39;pigeons(..., checkpoint = true)&#39; used above</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">PT(&quot;/home/runner/work/Pigeons.jl/Pigeons.jl/docs/build/results/all/2024-06-28-16-22-12-dNpWl6lG&quot;)</code></pre><h2 id="Running-MPI-on-a-cluster"><a class="docs-heading-anchor" href="#Running-MPI-on-a-cluster">Running MPI on a cluster</a><a id="Running-MPI-on-a-cluster-1"></a><a class="docs-heading-anchor-permalink" href="#Running-MPI-on-a-cluster" title="Permalink"></a></h2><div class="admonition is-info"><header class="admonition-header">The magic of distributed Parallel Tempering</header><div class="admonition-body"><p>If the dimensionality of the state space is large, you may worry that  the time to transmit states over the network would dominate the running time.  Remarkably, the size of the messages transmitted in the inner loop of our  algorithm does <strong>not</strong> depend on the state space. In a nutshell, the  machines only need to transmit the value of log density ratios (a single float).  See <a href="https://rss.onlinelibrary.wiley.com/doi/10.1111/rssb.12464">Algorithm 5 in Syed et al., 2021</a> for details.</p></div></div><p>MPI is typically available via a cluster scheduling system. At the time of  writing, <a href="https://github.com/openpbs/openpbs">PBS</a> and  <a href="https://slurm.schedmd.com/documentation.html">SLURM</a> are supported,  and an experimental implementation of <a href="https://www.ibm.com/docs/en/spectrum-lsf/10.1.0?topic=overview-lsf-introduction">LSF</a> is included.  Create an issue if you would like another submission system included. </p><p>Follow these instructions to run MPI over several machines:</p><ol><li>In the cluster login node, follow the <a href="../#installing-pigeons">local installation instructions</a>. </li><li>Start Julia in the login node, and perform a one-time setup. Read the documentation at <a href="../reference/#Pigeons.setup_mpi-Tuple{}"><code>setup_mpi()</code></a> for more information. </li><li>Still in the Julia REPL running in the login node, use:</li></ol><pre><code class="nohighlight hljs">mpi_run = pigeons(
    target = toy_mvn_target(1000000), 
    n_chains = 1000,
    checkpoint = true,
    on = MPIProcesses(
        n_mpi_processes = 1000,
        n_threads = 1))</code></pre><p>This will start a distributed PT algorithm with 1000 chains on 1000 MPIProcesses processes, each using one thread, targeting a one million  dimensional target distribution. On the UBC Sockeye cluster, the last  round of this run (i.e. the last 1024 iterations) takes 10 seconds to complete, versus more than  2 hours if run serially, i.e. a &gt;700x speed-up.  This is reasonably close to the theoretical 1000x speedup, i.e. we see that the communication costs are negligible. </p><p>You can &quot;watch&quot; the progress of your job (queue status and  standard output once it is available), using:</p><pre><code class="nohighlight hljs">watch(mpi_run)</code></pre><p>and cancel/kill a job using </p><pre><code class="nohighlight hljs">kill_job(mpi_run)</code></pre><p>To analyze the output, see the documentation page on <a href="../output-mpi-postprocessing/#output-mpi-postprocessing">post-processing for MPI runs</a>. In a nutshell, one option is to load the state of the sampler  back to your interactive chain via: </p><pre><code class="nohighlight hljs">pt = Pigeons.load(mpi_run) # possible thanks to &#39;pigeons(..., checkpoint = true)&#39; used above</code></pre><h2 id="Code-dependencies"><a class="docs-heading-anchor" href="#Code-dependencies">Code dependencies</a><a id="Code-dependencies-1"></a><a class="docs-heading-anchor-permalink" href="#Code-dependencies" title="Permalink"></a></h2><p>So far we have used examples where the target, explorers, etc  are built-in inside the Pigeons module.  However in typical use cases, some user-provided code needs to be provided to  <a href="../reference/#Pigeons.ChildProcess"><code>ChildProcess</code></a>  and <a href="../reference/#Pigeons.MPIProcesses"><code>MPIProcesses</code></a> so that the other participating Julia  processes have access to it.  This is done with the argument <code>dependencies</code> (of type <code>Vector</code>;  present in  both <a href="../reference/#Pigeons.ChildProcess"><code>ChildProcess</code></a>  and <a href="../reference/#Pigeons.MPIProcesses"><code>MPIProcesses</code></a>).  Two types of elements can be used in the vector of dependencies, and they can be mixed:</p><ul><li>elements of type <code>Module</code>: for each of those, an <code>using</code> statement will be generated in the script used by the child process;</li><li>elements of type <code>String</code>: a path to a Julia file defining functions and types, for each of those an <code>include</code> call is generated. </li></ul><p>Here is an example where we run a custom Ising model in a child process:</p><pre><code class="language-julia hljs">using Pigeons

# making the path absolute can be necessary in some contexts:
ising_path = pkgdir(Pigeons) * &quot;/examples/ising.jl&quot;
lazy_path = pkgdir(Pigeons) * &quot;/examples/lazy-ising.jl&quot;

pigeons(
    # see examples/lazy-ising.jl why we need Lazy (Documenter.jl-specific issue)
    target = Pigeons.LazyTarget(Val(:IsingLogPotential)),
    checkpoint = true,
    on = ChildProcess(
            n_local_mpi_processes = 2,
            dependencies = [
                Pigeons, # &lt;- Pigeons itself can be skipped, added automatically
                ising_path, # &lt;- these are needed for this example to work
                lazy_path   # &lt;--+
            ]

        )
    )</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Result{PT}(&quot;/home/runner/work/Pigeons.jl/Pigeons.jl/docs/build/results/all/2024-06-28-16-22-12-nnTYy3sp&quot;)</code></pre><p>Note the use of <code>LazyTarget(..)</code>.  When starting a child process, the arguments of <code>pigeons(...)</code> are used to create  an <a href="../reference/#Pigeons.Inputs"><code>Inputs</code></a> struct, which is serialized.  In certain corner cases this serialization may not be possible, for example if the  target depends on external processes, or here due to the fact that Documenter.jl  defines temporary environments (see examples/lazy-ising.jl for details). In these corner cases, you can use a <a href="../reference/#Pigeons.LazyTarget"><code>LazyTarget</code></a> to delay the creation of the  target so that it is performed in the child processes instead of the calling process.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>In order for the child processes to be able to load the same module versions as  the current process, the current process calls <code>Base.active_project()</code> and  pass that information to the child processes. The child processes will activate  that environment before proceeding to sampling.</p><p>We therefore assume that the environment given by <code>Base.active_project()</code> is  in working order.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../parallel/">« Parallelization</a><a class="docs-footer-nextpage" href="../variational/">Variational PT »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Friday 28 June 2024 16:26">Friday 28 June 2024</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
